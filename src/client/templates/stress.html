<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de IA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container wide">
        <h1>Test de Estrés</h1>
        <p class="subtitle">Sistema Distribuido IA</p>
        
        <nav class="nav">
            <a href="/train">Entrenar</a>
            <a href="/predict">Predecir</a>
            <a href="/results">Resultados</a>
            <a href="/stress" class="active">Test de estres</a>
        </nav>

        <div class="stress-config">
            <div class="config-section">
                <h3>Configuración Secuencial</h3>
                <div class="form-group">
                    <label>Número de peticiones</label>
                    <input type="number" id="seqRequests" value="100" min="1" max="1000">
                </div>
            </div>
            
            <div class="config-section">
                <h3>Configuración Concurrente</h3>
                <div class="form-group">
                    <label>Número de peticiones</label>
                    <input type="number" id="concRequests" value="500" min="1" max="5000">
                </div>
                <div class="form-group">
                    <label>Hilos paralelos</label>
                    <input type="number" id="threads" value="50" min="1" max="200">
                </div>
            </div>
        </div>

        <div class="test-controls">
            <button id="runSeqBtn" class="test-btn">Ejecutar Secuencial</button>
            <button id="runConcBtn" class="test-btn success">Ejecutar Concurrente</button>
            <button id="runBothBtn" class="test-btn secondary">Ejecutar Ambos</button>
        </div>

        <div id="progress" class="progress-section" style="display: none;">
            <div class="progress-label">Progreso</div>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">0 / 0</div>
        </div>

        <div class="results-section">
            <div class="result-card" id="seqResults" style="display: none;">
                <h3>Resultados Secuencial</h3>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">Peticiones</span>
                        <span class="metric-value" id="seqTotal">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Exitosas</span>
                        <span class="metric-value success-text" id="seqSuccess">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Fallidas</span>
                        <span class="metric-value error-text" id="seqErrors">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Duración</span>
                        <span class="metric-value" id="seqDuration">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Throughput</span>
                        <span class="metric-value" id="seqThroughput">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Tiempo Avg</span>
                        <span class="metric-value" id="seqAvg">-</span>
                    </div>
                </div>
            </div>

            <div class="result-card" id="concResults" style="display: none;">
                <h3>Resultados Concurrente</h3>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">Peticiones</span>
                        <span class="metric-value" id="concTotal">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Exitosas</span>
                        <span class="metric-value success-text" id="concSuccess">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Fallidas</span>
                        <span class="metric-value error-text" id="concErrors">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Duración</span>
                        <span class="metric-value" id="concDuration">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Throughput</span>
                        <span class="metric-value" id="concThroughput">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Tiempo Avg</span>
                        <span class="metric-value" id="concAvg">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const runSeqBtn = document.getElementById('runSeqBtn');
        const runConcBtn = document.getElementById('runConcBtn');
        const runBothBtn = document.getElementById('runBothBtn');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        function disableButtons(disabled) {
            runSeqBtn.disabled = disabled;
            runConcBtn.disabled = disabled;
            runBothBtn.disabled = disabled;
        }

        function showProgress(current, total) {
            progress.style.display = 'block';
            const percent = (current / total) * 100;
            progressBar.style.width = percent + '%';
            progressText.textContent = `${current} / ${total}`;
        }

        function hideProgress() {
            progress.style.display = 'none';
        }

        function displayResults(type, data) {
            const prefix = type === 'sequential' ? 'seq' : 'conc';
            const card = document.getElementById(`${prefix}Results`);
            
            document.getElementById(`${prefix}Total`).textContent = data.total;
            document.getElementById(`${prefix}Success`).textContent = `${data.success} (${((data.success/data.total)*100).toFixed(1)}%)`;
            document.getElementById(`${prefix}Errors`).textContent = data.errors;
            document.getElementById(`${prefix}Duration`).textContent = data.duration.toFixed(2) + 's';
            document.getElementById(`${prefix}Throughput`).textContent = (data.total / data.duration).toFixed(2) + ' req/s';
            document.getElementById(`${prefix}Avg`).textContent = data.avg_ms.toFixed(1) + 'ms';
            
            card.style.display = 'block';
        }

        async function runTest(mode) {
            const seqRequests = parseInt(document.getElementById('seqRequests').value);
            const concRequests = parseInt(document.getElementById('concRequests').value);
            const threads = parseInt(document.getElementById('threads').value);

            const config = {
                mode: mode,
                sequential: { requests: seqRequests },
                concurrent: { requests: concRequests, threads: threads }
            };

            disableButtons(true);
            showProgress(0, mode === 'both' ? seqRequests + concRequests : (mode === 'sequential' ? seqRequests : concRequests));

            try {
                const res = await fetch('/stress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(l => l.trim());

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            
                            if (data.type === 'progress') {
                                showProgress(data.current, data.total);
                            } else if (data.type === 'result') {
                                displayResults(data.mode, data.data);
                            }
                        } catch (e) {}
                    }
                }
            } catch (err) {
                alert('Error al ejecutar test: ' + err.message);
            } finally {
                hideProgress();
                disableButtons(false);
            }
        }

        runSeqBtn.addEventListener('click', () => runTest('sequential'));
        runConcBtn.addEventListener('click', () => runTest('concurrent'));
        runBothBtn.addEventListener('click', () => runTest('both'));
    </script>
</body>
</html>
